# Настройка прокси для OpenAI API

Если вы находитесь в регионе, где OpenAI API недоступен (например, в России), вам необходимо настроить прокси или VPN для доступа к API.

## Типы прокси

Приложение поддерживает два типа прокси:

1. **HTTP/HTTPS прокси** - наиболее распространенный тип, работает с большинством прокси-серверов
2. **SOCKS5/SOCKS4 прокси** - более универсальный протокол, часто используется VPN-сервисами

**Какой тип использовать?**
- Если ваш прокси-сервер поддерживает HTTP - используйте HTTP (проще и быстрее)
- Если ваш VPN/прокси предоставляет только SOCKS5 - используйте SOCKS5
- Если не уверены - попробуйте сначала HTTP, затем SOCKS5

## Варианты настройки

### Вариант 1: HTTP/HTTPS прокси (рекомендуется)

Добавьте в файл `.env`:

```env
# HTTP прокси для OpenAI API
OPENAI_PROXY=http://proxy.example.com:8080
```

Или если прокси требует аутентификацию:

```env
OPENAI_PROXY=http://username:password@proxy.example.com:8080
```

**Примечание:** Если схема не указана (например, `209.46.3.136:8000`), приложение автоматически добавит `http://`.

### Вариант 2: SOCKS5 прокси

Для использования SOCKS5 прокси необходимо установить дополнительную зависимость:

```bash
# Базовая поддержка (без аутентификации)
pip install httpx[socks]

# Рекомендуется: расширенная поддержка с аутентификацией
pip install httpx-socks
```

Затем в файле `.env`:

**SOCKS5 без аутентификации:**
```env
# SOCKS5 прокси для OpenAI API
OPENAI_PROXY=socks5://proxy.example.com:1080
```

**SOCKS5 с аутентификацией (логин и пароль):**
```env
# Формат: socks5://username:password@host:port
OPENAI_PROXY=socks5://myuser:mypassword@proxy.example.com:1080
```

**SOCKS4 также поддерживается:**
```env
# Без аутентификации
OPENAI_PROXY=socks4://proxy.example.com:1080

# С аутентификацией
OPENAI_PROXY=socks4://username:password@proxy.example.com:1080
```

**Важно:** Для SOCKS5 с аутентификацией рекомендуется установить `httpx-socks`, так как стандартный `httpx[socks]` может не поддерживать аутентификацию должным образом.

### Вариант 3: Использование стандартных переменных окружения

Можно использовать стандартные переменные `HTTP_PROXY` или `HTTPS_PROXY`:

```env
HTTPS_PROXY=http://proxy.example.com:8080
HTTP_PROXY=http://proxy.example.com:8080
```

Приоритет: `OPENAI_PROXY` > `HTTPS_PROXY` > `HTTP_PROXY`

## Примеры использования

### HTTP прокси с аутентификацией
```env
OPENAI_PROXY=http://username:password@209.46.3.136:8000
```

### SOCKS5 прокси с аутентификацией
```env
OPENAI_PROXY=socks5://myuser:mypass123@proxy.example.com:1080
```

### SOCKS5 прокси без аутентификации
```env
OPENAI_PROXY=socks5://127.0.0.1:1080
```

### HTTP прокси без аутентификации
```env
OPENAI_PROXY=http://127.0.0.1:8080
```

## Примеры популярных VPN/прокси сервисов

### Локальный прокси-сервер

Если у вас есть локальный прокси-сервер (например, через VPN клиент):

```env
OPENAI_PROXY=http://127.0.0.1:1080
```

### Облачные прокси сервисы

Многие VPN-сервисы предоставляют прокси-серверы. Обычно формат:

```env
OPENAI_PROXY=http://server-address:port
```

## Проверка работы

После настройки прокси:

1. Перезапустите приложение:
   ```bash
   uvicorn app.main:app --reload
   ```

2. В логах вы должны увидеть:
   ```
   INFO: Использование прокси для OpenAI: proxy.example.com:8080
   INFO: ChatGPT сервис инициализирован (через прокси)
   ```

3. Попробуйте отправить запрос с изображением еды. Если прокси работает, запрос должен пройти успешно.

## Устранение проблем

### Прокси не работает

1. **Проверьте формат URL прокси:**
   - Правильно: `http://proxy.example.com:8080`
   - Неправильно: `proxy.example.com:8080` (без протокола)

2. **Проверьте доступность прокси:**
   ```bash
   curl -x http://proxy.example.com:8080 https://api.openai.com/v1/models
   ```

3. **Проверьте логи приложения** на наличие ошибок подключения

4. **Убедитесь, что прокси поддерживает HTTPS** (OpenAI API использует HTTPS)

### Таймауты

Если запросы зависают, попробуйте другой прокси-сервер или увеличьте таймаут (в коде установлен 60 секунд).

### Аутентификация прокси

Если прокси требует аутентификацию, обязательно включите логин и пароль в URL:
```env
OPENAI_PROXY=http://username:password@proxy.example.com:8080
```

## Настройка на сервере

Для продакшн-сервера:

1. Установите прокси-сервер или VPN клиент на сервере
2. Настройте прокси в `.env` файле (как описано выше)
3. Убедитесь, что прокси работает постоянно и автоматически переподключается при обрыве связи

### Рекомендации для продакшн

- Используйте надежный прокси-сервис с высокой доступностью (uptime > 99%)
- Настройте мониторинг доступности прокси
- Рассмотрите возможность использования резервного прокси
- Используйте прокси с низкой задержкой для лучшей производительности

## Альтернативные решения

Если прокси не подходит, можно рассмотреть:

1. **Использование прокси-сервиса** вместо прямого подключения
2. **VPN на уровне сервера** с автоматическим реконнектом
3. **Использование альтернативных API** (если доступны)


